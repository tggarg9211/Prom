<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Night of Promises</title>
    <style>
        :root {
            --bg-color: #02040a;
            --star-white: #f8f9fa;
            --accent-glow: rgba(180, 160, 255, 0.4);
            --text-main: #d1d1d1;
            --font-serif: "Times New Roman", Times, serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-serif);
            letter-spacing: 0.05em;
        }

        #canvas, #constellation {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        #constellation {
            z-index: 2;
            opacity: 0;
            transition: opacity 3s ease;
        }

        #audio-toggle {
            position: fixed;
            top: 25px;
            right: 25px;
            z-index: 100;
            font-size: 9px;
            text-transform: uppercase;
            opacity: 0.3;
            letter-spacing: 0.2em;
        }

        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 2s ease;
            padding: 20px;
            text-align: center;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
        }

        #intro-text { font-size: 1.1rem; line-height: 1.8; font-style: italic; }

        .promise-star {
            position: absolute;
            width: 14px;
            height: 14px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px var(--star-white);
            cursor: pointer;
            z-index: 20;
            transition: transform 0.4s ease, box-shadow 0.6s ease;
        }

        .promise-star.opened {
            box-shadow: 0 0 25px 8px var(--accent-glow);
            transform: scale(1.3);
            background: #fff;
        }

        #promise-overlay {
            position: fixed;
            inset: 0;
            background: rgba(2, 4, 10, 0.98);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        #promise-content {
            font-size: 1.15rem;
            max-width: 320px;
            line-height: 1.7;
            margin-bottom: 40px;
            white-space: pre-line;
            color: #fff;
        }

        .close-hint { font-size: 0.65rem; text-transform: uppercase; opacity: 0.4; letter-spacing: 0.3em; }

        #seal-area {
            width: 120px;
            height: 120px;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin: 0 auto;
        }

        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 1px solid var(--accent-glow);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.4; }
            100% { transform: scale(1.6); opacity: 0; }
        }

        /* ---------------------------------------------------
           THE FINAL SCREEN - COMPLETELY REBUILT FOR PERFECTION
           --------------------------------------------------- */
        #screen-final {
            display: grid; /* Grid stacking guarantees perfect center */
            place-items: center;
            padding: 20px;
        }

        .final-stage {
            grid-area: 1 / 1; /* Stacks all elements in the exact same spot */
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transform: translateY(15px); /* Starts slightly lower */
            transition: opacity 2.5s ease-in-out, transform 2.5s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .final-stage p {
            font-size: 1.25rem;
            line-height: 1.6;
            max-width: 300px;
        }

        .final-stage.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0); /* Rises to center */
        }

        .final-stage.exit {
            opacity: 0;
            visibility: hidden;
            transform: translateY(-15px); /* Drifts up smoothly as it fades out */
        }

        /* --- Cinematic Photo Framing --- */
        #photo-wrapper {
            position: relative;
            padding: 8px; /* Creates a soft polaroid-like frame */
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); /* Deep shadow */
            overflow: hidden; /* Clips the image zoom animation */
        }

        #final-image {
            display: block;
            max-width: 85vw; /* Keeps it perfectly sized on mobile */
            max-height: 50vh;
            border-radius: 6px;
            object-fit: cover;
            transform: scale(1.08); /* Starts zoomed in slightly */
            transition: transform 12s cubic-bezier(0.1, 0, 0.1, 1); /* Slow, epic zoom out */
        }

        .final-stage.active #final-image {
            transform: scale(1); /* Settles to normal size as it fades in */
        }

        #final-caption {
            margin-top: 25px;
            font-size: 1.3rem;
            font-style: italic;
            color: var(--star-white);
            letter-spacing: 0.08em;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5); /* Glows slightly in the dark */
        }

    </style>
</head>
<body>

    <div id="audio-toggle">Sound: Off</div>
    <audio id="ambient-track" loop preload="auto">
        <source src="ambient.mp3" type="audio/mpeg">
    </audio>

    <canvas id="canvas"></canvas>
    <canvas id="constellation"></canvas>

    <div class="screen active" id="screen-intro" onclick="startSequence()">
        <div id="intro-text">
            <p id="line-1" style="opacity: 0;">Some words are too important to be spoken casuallyâ€¦</p>
            <p id="line-2" style="opacity: 0; margin-top: 25px;">Few from my heart\nFor you .</p>
            <p id="tap-hint" style="opacity: 0; margin-top: 60px; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.4em;">Tap to enter</p>
        </div>
    </div>

    <div class="screen" id="screen-sky">
        <div style="position:absolute; bottom:8vh; font-size: 0.65rem; opacity:0.4; text-transform:uppercase; letter-spacing: 0.2em;">Choose a star</div>
    </div>

    <div class="screen" id="screen-seal">
        <div>
            <p style="margin-bottom: 50px; font-style: italic; opacity: 0.8;">Now our promises belong to the same sky.</p>
            <div id="seal-trigger">
                <div id="seal-area">
                    <div class="pulse-ring"></div>
                    <div style="font-size: 0.6rem; opacity: 0.5; letter-spacing: 0.2em;">HOLD</div>
                </div>
                <p style="margin-top: 30px; font-size: 0.65rem; opacity: 0.3; text-transform: uppercase;">Press and hold to seal</p>
            </div>
        </div>
    </div>

    <div class="screen" id="screen-final">
        <div class="final-stage" id="stage-1">
            <p>And my most important promise...</p>
        </div>
        
        <div class="final-stage" id="stage-2">
            <p>No matter where life takes us... you will never walk alone.</p>
        </div>

        <div class="final-stage" id="stage-3">
            <div id="photo-wrapper">
                <img id="final-image" src="image.jpg" alt="Us">
            </div>
            <p id="final-caption">Happy Promise Day Sushii ðŸ‘‰ðŸ‘ˆ</p>
        </div>
    </div>

    <div id="promise-overlay" onclick="closePromise()">
        <div id="promise-content"></div>
        <div class="close-hint">Tap to release</div>
    </div>

    <script>
        const promises = [
            "Mine favourite is your's favourite too, you.",
            "I will always protect you from everything that is bad for you, even me, when I will be bad for you ðŸ˜‚.",
            "Tu tension mat liya kr...\n'MAIN HUN NA.'",
            "We will get there.\nBut right now you are here.\nAnd here is beautiful.",
            "Staying will never be our flaw.\nLoving will be our courage.",
            "If there is even a slight chance at getting something that will make you happy, I will risk it.\nLife is too short and happiness is too rare :)",
            "â€œYou and I were always just a daydream I took too far... and maybe I'll take it even farther.â€"
        ];

        let openedCount = 0;
        let audioStarted = false;
        let typingInProgress = false;
        const starElements = [];
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        let width, height;

        function initCanvas() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', initCanvas);
        initCanvas();

        const particles = Array.from({ length: 80 }, () => ({
            x: Math.random() * width,
            y: Math.random() * height,
            size: Math.random() * 1.5,
            speed: Math.random() * 0.1 + 0.05
        }));

        function drawParticles() {
            ctx.clearRect(0, 0, width, height);
            ctx.fillStyle = "white";
            particles.forEach(p => {
                p.y -= p.speed;
                if (p.y < 0) p.y = height;
                ctx.globalAlpha = 0.2;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            requestAnimationFrame(drawParticles);
        }
        drawParticles();

        setTimeout(() => { document.getElementById('line-1').style.opacity = 1; }, 1000);
        setTimeout(() => { document.getElementById('line-2').style.opacity = 1; }, 3500);
        setTimeout(() => { document.getElementById('tap-hint').style.opacity = 0.5; }, 5500);

        function startSequence() {
            transitionTo('screen-sky');
            createStars();
        }

        function createStars() {
            const container = document.getElementById('screen-sky');
            promises.forEach((text, i) => {
                const star = document.createElement('div');
                star.className = 'promise-star';
                star.style.left = `${15 + Math.random() * 70}%`;
                star.style.top = `${15 + Math.random() * 60}%`;
                
                star.onclick = (e) => {
                    e.stopPropagation();
                    
                    if (!audioStarted) {
                        const audio = document.getElementById('ambient-track');
                        audio.play().then(() => {
                            audioStarted = true;
                            document.getElementById('audio-toggle').innerText = "Sound: On";
                        }).catch(err => console.log("Audio waiting"));
                    }
                    
                    if (!typingInProgress) openPromise(text, star);
                };
                container.appendChild(star);
                starElements.push(star);
            });
        }

        function openPromise(text, el) {
            typingInProgress = true;
            const overlay = document.getElementById('promise-overlay');
            const content = document.getElementById('promise-content');
            content.textContent = ""; 
            overlay.style.display = 'flex';
            
            let i = 0;
            const typeDelay = 40;
            
            function type() {
                if (i < text.length) {
                    content.textContent += text.charAt(i);
                    i++;
                    setTimeout(type, typeDelay);
                } else {
                    typingInProgress = false;
                }
            }
            type();

            if (!el.classList.contains('opened')) {
                el.classList.add('opened');
                openedCount++;
            }
        }

        function closePromise() {
            if (typingInProgress) return;
            document.getElementById('promise-overlay').style.display = 'none';
            if (openedCount === promises.length) {
                setTimeout(() => {
                    drawConstellation();
                    transitionTo('screen-seal');
                }, 1200);
            }
        }

        function drawConstellation() {
            const c = document.getElementById('constellation');
            const cx = c.getContext('2d');
            c.width = window.innerWidth;
            c.height = window.innerHeight;
            c.style.opacity = "1";
            cx.strokeStyle = "rgba(180, 160, 255, 0.2)";
            cx.lineWidth = 1;
            cx.beginPath();
            starElements.forEach((s, idx) => {
                const rect = s.getBoundingClientRect();
                const x = rect.left + 7;
                const y = rect.top + 7;
                if (idx === 0) cx.moveTo(x, y);
                else cx.lineTo(x, y);
            });
            cx.stroke();
        }

        function transitionTo(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        const sealTrigger = document.getElementById('seal-trigger');
        let sealTimer;
        
        const startSeal = (e) => {
            e.preventDefault();
            document.querySelector('.pulse-ring').style.animationDuration = '0.6s';
            sealTimer = setTimeout(() => {
                transitionTo('screen-final');
                showFinalMessage();
            }, 2000);
        };
        
        const endSeal = () => {
            clearTimeout(sealTimer);
            document.querySelector('.pulse-ring').style.animationDuration = '3s';
        };

        sealTrigger.addEventListener('mousedown', startSeal);
        sealTrigger.addEventListener('touchstart', startSeal);
        window.addEventListener('mouseup', endSeal);
        window.addEventListener('touchend', endSeal);

        /* --- THE FIXED SEQUENCER --- */
        function showFinalMessage() {
            const stage1 = document.getElementById('stage-1');
            const stage2 = document.getElementById('stage-2');
            const stage3 = document.getElementById('stage-3');

            // 1. First line appears
            setTimeout(() => { stage1.classList.add('active'); }, 1000);

            // 2. First line drifts up and fades out
            setTimeout(() => { 
                stage1.classList.remove('active'); 
                stage1.classList.add('exit'); 
            }, 5500);

            // 3. Second line appears
            setTimeout(() => { stage2.classList.add('active'); }, 8000);

            // 4. Second line drifts up and fades out
            setTimeout(() => { 
                stage2.classList.remove('active'); 
                stage2.classList.add('exit'); 
            }, 12500);

            // 5. Photo & Caption appear (Photo will slow-zoom automatically)
            setTimeout(() => { stage3.classList.add('active'); }, 15500);
        }
    </script>
</body>
</html>
